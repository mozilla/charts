<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<title>FFOS Blockers</title>
	<script type="text/javascript">function importScript(dep, func){if (func!==undefined) func();}</script>
	<script type="text/javascript" src="js/Settings.js"></script>
	<script type="text/javascript" src="js/rest/BugzillaClient.js"></script>
	<link type="text/css" rel="stylesheet" href="b2g/blockers.css"/>
	<script type="text/javascript" src="js/util/aUtil.js"></script>
	<script type="text/javascript" src="js/util/aString.js"></script>
	<script type="text/javascript" src="b2g/owners.js"></script>
	<script type="text/javascript" src="js/collections/aMatrix.js"></script>
	<script type="text/javascript" src="js/qb/Qb.aggregate.js"></script>
	<script type="text/javascript" src="js/qb/Qb.column.js"></script>
	<script type="text/javascript" src="js/qb/Qb.cube.js"></script>
	<script type="text/javascript" src="js/qb/Qb.analytic.js"></script>
	<script type="text/javascript" src="js/gui/Filter.js"></script>
	<script type="text/javascript" src="js/gui/ComponentFilter.js"></script>
	<script type="text/javascript" src="js/gui/PartitionFilter.js"></script>
	<script type="text/javascript" src="js/qb/aCompiler.js"></script>
	<script type="text/javascript" src="js/collections/aArray.js"></script>
	<script type="text/javascript" src="js/util/aParse.js"></script>
	<script type="text/javascript" src="js/collections/aRelation.js"></script>
	<script type="text/javascript" src="js/math/aMath.js"></script>
	<script type="text/javascript" src="js/MozillaPrograms.js"></script>
	<script type="text/javascript" src="js/util/CNV.js"></script>
	<script type="text/javascript" src="js/util/aTemplate.js"></script>
	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="js/util/aDate.js"></script>
	<script type="text/javascript" src="js/collections/aQueue.js"></script>
	<script type="text/javascript" src="js/collections/aSet.js"></script>
	<script type="text/javascript" src="js/debug/aException.js"></script>
	<script type="text/javascript" src="lib/jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
	<script type="text/javascript" src="lib/jquery.numberformatter.js"></script>
	<script type="text/javascript" src="lib/jstree/jquery.jstree.js"></script>
	<script type="text/javascript" src="js/qb/Qb.domain.js"></script>
	<script type="text/javascript" src="js/util/aDuration.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-ui/css/start/jquery-ui-1.10.2.custom.css">
	<script type="text/javascript" src="js/aFormat.js"></script>
	<script type="text/javascript" src="js/gui/TeamFilter.js"></script>
	<script type="text/javascript" src="js/debug/aLog.js"></script>
	<script type="text/javascript" src="lib/jquery.ba-bbq/jquery.ba-bbq.js"></script>
	<script type="text/javascript" src="js/threads/thread.js"></script>
	<script type="text/javascript" src="js/gui/ProgramFilter.js"></script>
	<script type="text/javascript" src="js/util/aTimer.js"></script>

	<script type="text/javascript" src="js/rest/Rest.js"></script>
	<script type="text/javascript" src="js/aLibrary.js"></script>

	<script type="text/javascript" src="js/rest/ElasticSearch.js"></script>
	<script type="text/javascript" src="js/Bugzilla.js"></script>
	<script type="text/javascript" src="js/math/Stats.js"></script>
	<script type="text/javascript" src="js/qb/MVEL.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-linedtextarea/jquery-linedtextarea.css">
	<script type="text/javascript" src="js/qb/Qb.js"></script>
	<script type="text/javascript" src="lib/jquery-linedtextarea/jquery-linedtextarea.js"></script>
	<script type="text/javascript" src="js/qb/ESQuery.js"></script>
	<script type="text/javascript" src="js/Dimension.js"></script>
	<script type="text/javascript" src="js/Dimension-Bugzilla.js"></script>
	<script type="text/javascript" src="js/Dimension-B2G.js"></script>
	<script type="text/javascript" src="js/gui/ProductFilter.js"></script>
	<script type="text/javascript" src="js/charts/aColor.js"></script>
	<script type="text/javascript" src="js/gui/GUI.js"></script>
	<script type="text/javascript" src="js/Hierarchy.js"></script>

	<script type="text/javascript" src="b2g/heat.js"></script>
	<link type="text/css" rel="stylesheet" href="css/menu.css">
	<script type="text/javascript" src="b2g/main_lib.js"></script>
	<style id="vakata-stylesheet" type="text/css"></style>
	<style id="jstree-stylesheet" type="text/css"></style>
	<link rel="stylesheet" type="text/css" media="all" href="lib/jstree/themes/default/style.css">

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49796218-5', 'mozilla.org');
  ga('send', 'pageview');
	</script>
</HEAD>
<BODY style="display: none;">
<div style="overflow:hidden;">
	<div id="sidebar">
		<div id="description" style="width:300px;">
			Each component is colored on a continuous scale (<div style="vertical-align:middle;height:15px; width:150px; background: -moz-linear-gradient(left, #009F00,#699B00,  #CA7900,#954000, #A50303);position: relative;display:inline-block;"><div style="top:-3px;left:1px;color:white;position: absolute;font-size: 15px">New</div><div style="top:-3px;right:1px;color:white;position: absolute;font-size: 15px">Old</div></div>)
			according to the time since the most stale one has changed.  Green is new, while red is 7days or older.
			If the component has unassigned members, then it is marked with a <div style="display:inline-block;bottom:0;width: 0;height: 0; border-style: solid; border-width: 0 0 15px 15px; border-color: transparent transparent #000000 transparent;"></div>
			 along with the count.
		</div>

		<hr>
		<div id="filters" style="width:300px;" class="menu">
		</div>
	</div>
	<div class="sidebar_name">
		<div>Filters</div>
	</div>
	<div class="content" style="position:inherit;">
		<div id="totals"><h3 style="display:inline-block;">FFOS Blockers</h3></div>
		<div style="position:absolute;top:5px;right:10px;">
			Age: <div style="vertical-align:middle;height:15px; width:150px; background: -moz-linear-gradient(left, #009F00,#699B00,  #CA7900,#954000, #A50303);position: relative;display:inline-block;"><div style="top:-3px;left:1px;color:white;position: absolute;font-size: 15px">New</div><div style="top:-3px;right:1px;color:white;position: absolute;font-size: 15px">7days+</div></div><br>
			Unassigned Bugs:<div style="display:inline-block;bottom:0;width: 0;height: 0; border-style: solid; border-width: 0 0 15px 15px; border-color: transparent transparent #000000 transparent;"></div>
		</div>
		<div id="blockers"></div>
	</div>
	<div class="footer">
		Source at <a href="https://github.com/mozilla/charts/blob/master/ffos/blockers.html">https://github.com/mozilla/charts/blob/master/ffos/blockers.html</a>
	</div>
</div>
<script type="application/javascript">

	importScript('b2g/main_lib.js', function () {
		heatCommon();

		var thread;
		function createChart() {
			if (thread !== undefined)
				thread.kill(true);
			thread = Thread.run(__createChart());
		}
		refresher(createChart);

		var __createChart = function*() {
			yield (ESQuery.loadColumns({"from": "bugs"}));

			//THESE ARE IMPORTANT BLOCKERS
			var a = Log.action("Get Hierarchy", true);
			var possibleTree = (yield(ESQuery.run({
				"from": "bug_hierarchy",
				"select": [
					"bug_id",
					"descendants"
				],
				"esfilter": {"term": {"bug_id":984663}}
			}))).list;
			if (possibleTree.length==0){
				possibleTree=[];
			}else{
				possibleTree=possibleTree[0].descendants;
			}//endif
			possibleTree.append(984663);

			var allTree;
			var allTreeThread=Thread.run(function*(){
				try{
					allTree = (yield(ESQuery.run({
						"from": "bug_dependencies",
						"select": [
							"bug_id",
							"dependson"
						],
						"esfilter":	{"and": [
							{"terms":{"bug_id": possibleTree}},
							Mozilla.CurrentRecords.esfilter
						]}
					}))).list;
					allTree.append(0)
				}catch(e){
					//WHEN THE
					allTree=[0];
				}
			});

			var allOpen;
			var allOpenThread=Thread.run(function*(){
				allOpen = (yield(ESQuery.run({
					"from": "bugs",
					"select": "bug_id",
					"esfilter":	{"and": [
						{"terms":{"bug_id": possibleTree}},
						Mozilla.BugStatus.Open.esfilter,
						Mozilla.CurrentRecords.esfilter
					]}
				}))).list
			});

			yield (Thread.join(allTreeThread));
			yield (Thread.join(allOpenThread));

			allTree = allTree.filter(function(v){
				return v.bug_id==984663 || allOpen.contains(v.bug_id);
			});

			yield (Hierarchy.addDescendants({
		       "from":allTree,
		       "id_field":"bug_id",
		       "fk_field":"dependson",
		       "descendants_field": "dependencies"
		    }));
			Log.actionDone(a);

			var CABlockers = Array.union(allTree.filter({"term":{"bug_id":984663}}).select("dependencies")).map(function(v){return v-0;});

			a = Log.action("Get Bug Details", true);
			//PULL THE RAW DATA, AND THEN OPERATE ON IT 112K, 2.17sec time
			//THE AGGREGATES ARE SPENDING ABOUT 2/3 THE TIME TRANSMITTING THE QUERY
			var allDetails = yield(ESQuery.run({
				"from": "bugs",
				"select": [
					"bug_id",
					"modified_ts",
					"keywords",
					"assigned_to",
					"component",
					"product",
					"cf_blocking_b2g",
					"cf_blocking_loop"
				],
				"esfilter":	{"and": [
					{"or":[
						Mozilla.B2G.Blockers.esfilter,
						{"terms":{"bug_id":CABlockers}}
					]},
					Mozilla.BugStatus.Open.esfilter,
					Mozilla.CurrentRecords.esfilter,
					GUI.getFilters("bugs")
				]}
			}));
			Log.actionDone(a);

			var components = yield(Q({
				"from": allDetails,
				"select": [
					{"name": "count", "value": "bug_id", "aggregate": "count"},
					{"name": "bugs", "value": "bug_id", "aggregate": "array"},
					{"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "maximum"},
					{"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"},
					{"name": "unassignedBugs", "value": '(assigned_to=="nobody@mozilla.org" ? bug_id : null)', "aggregate": "array"}
				],
				"edges": [
					"component",
					{"name": "project", "domain": Mozilla.B2G.Project.getDomain()}
				]
			}));


			$("#blockers").html("");
			components.cube.forall(function (component, i) {
				var total = aMath.sum.apply(undefined, component.select("count"));
				if (total > 0) {
					component.forall(function (project, j) {
						project.component = components.edges[0].domain.partitions[i].name;
						project.project = components.edges[1].domain.partitions[j].name;
						project.total = total;
						project.additionalClass = "";
					});
					var blockerHTML = showComponent(component, showBlocker);
					$("#blockers").append(blockerHTML);
				}//endif
			});

			var projectDomain=Mozilla.B2G.Project.getDomain();
			projectDomain.name="project";
			projectDomain.end=function(p){return p.name;};
			var totals = yield(Q({
				"from": allDetails,
				"select": [
//					{"name": "project", "value": "project.name", "aggregate": "one"},
					{"name": "additionalClass", "value": '"project-summary"', "aggregate": "one"},
					{"name": "count", "value": "bug_id", "aggregate": "count"},
					{"name": "bugs", "value": "bug_id", "aggregate": "array"},
					{"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "maximum"},
					{"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"},
					{"name": "unassignedBugs", "value": '(assigned_to=="nobody@mozilla.org" ? bug_id : null)', "aggregate": "array"}
				],
				"edges": [
					{"name": "project", "domain": projectDomain}
				]
			}));

			var specialBlockers = (yield(Q({
				"from": allDetails,
				"select": [
					{"name": "project", "value": '"CAF"', "aggregate": "one"},
					{"name": "additionalClass", "value":'"project-summary"', "aggregate":"one"},
					{"name": "count", "value": "bug_id", "aggregate": "count"},
					{"name": "bugs", "value": "bug_id", "aggregate": "array"},
					{"name": "bugsList", "value": "bug_id", "aggregate": "join", "separator": ","},
					{"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "maximum"},
					{"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"}
				],
				"where": {"terms":{"bug_id":CABlockers}}
			}))).cube;

			if (specialBlockers.count==0) specialBlockers.project="CAF";

			var blockerHTML = showSummary("Blockers", GUI.state.team.getSelectedParts(), totals, specialBlockers, showBlocker);
			$("#totals").html(blockerHTML);

			addProjectClickers(components);
		};

		$(document).ready(function () {
			GUI.setup(
					createChart,
					[
						{"id": "project", "name": "Releases", "type": PartitionFilter.newInstance({
							"id": "Projects",
							"name": "All Projects",
							"dimension": Mozilla.B2G.Project,
							"onlyOne": false,
							"expandAll": true
						})},
						{"id": "team", "name": "Teams", "type": PartitionFilter.newInstance({
							"id": "Teams",
							"name": "All Teams",
							"dimension": Mozilla.B2G.Team,
							"onlyOne": false,
							"expandAll": true
						})},
						{"id": "component", "name": "Components", "type": PartitionFilter.newInstance({
							"id": "Components",
							"name": "All Components",
							"dimension": Mozilla.B2G.Component,
							"onlyOne": false,
							"expandAll": true
						})},
						{"id": "responsibility", "name": "Responsibility", "default":"FFOS_Team", "type": PartitionFilter.newInstance({
							"id": "Responsibility",
							"name": "All Bugs",
							"dimension": Mozilla.B2G.Responsibility,
							"onlyOne": true,
							"expandAll": true
						})}
					],
					[],
					null,
					false		//SHOW DEFAULT FILTERS?
			);
		});
	});
</script>


</BODY>
</HTML>




