<!DOCTYPE html>
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<head>
  <meta charset="utf-8">

<title>Feature Burndown</title>
<script type="text/javascript">function importScript(dep, func){
	if (func !== undefined) func();
}</script>
<script type="text/javascript" src="modevlib/MozillaPrograms.js"></script>
<script type="text/javascript" src="modevlib/rest/BugzillaClient.js"></script>
<script type="text/javascript" src="modevlib/util/aUtil.js"></script>
<script type="text/javascript" src="modevlib/util/aParse.js"></script>
<script type="text/javascript" src="modevlib/collections/aMatrix.js"></script>
<script type="text/javascript" src="modevlib/qb/Qb.aggregate.js"></script>
<script type="text/javascript" src="modevlib/qb/Qb.column.js"></script>
<script type="text/javascript" src="modevlib/qb/Qb.cube.js"></script>
<script type="text/javascript" src="modevlib/qb/Qb.analytic.js"></script>
<script type="text/javascript" src="modevlib/math/aMath.js"></script>
<script type="text/javascript" src="modevlib/gui/Filter.js"></script>
<script type="text/javascript" src="modevlib/gui/ComponentFilter.js"></script>
<script type="text/javascript" src="modevlib/gui/PartitionFilter.js"></script>
<script type="text/javascript" src="modevlib/qb/aCompiler.js"></script>
<script type="text/javascript" src="modevlib/collections/aRelation.js"></script>
<script type="text/javascript" src="modevlib/util/aString.js"></script>
<script type="text/javascript" src="modevlib/util/aHTML.js"></script>
<script type="text/javascript" src="modevlib/collections/aArray.js"></script>
<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="modevlib/util/convert.js"></script>
<script type="text/javascript" src="modevlib/util/aDate.js"></script>
<script type="text/javascript" src="modevlib/collections/aQueue.js"></script>
<script type="text/javascript" src="modevlib/collections/aSet.js"></script>
<script type="text/javascript" src="modevlib/util/aTemplate.js"></script>
<script type="text/javascript" src="lib/jquery.numberformatter.js"></script>
<script type="text/javascript" src="lib/jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
<script type="text/javascript" src="lib/jstree/jquery.jstree.js"></script>
<script type="text/javascript" src="modevlib/debug/aException.js"></script>
<script type="text/javascript" src="modevlib/qb/Qb.domain.js"></script>
<script type="text/javascript" src="modevlib/util/aDuration.js"></script>
<script type="text/javascript" src="lib/ccc/lib/protovis-d3.3.js"></script>
<script type="text/javascript" src="modevlib/aFormat.js"></script>
<link type="text/css" rel="stylesheet" href="lib/jquery-ui/css/start/jquery-ui-1.10.2.custom.css"/>
<script type="text/javascript" src="modevlib/gui/TeamFilter.js"></script>
<script type="text/javascript" src="lib/ccc/lib/protovis-msie.js"></script>
<script type="text/javascript" src="lib/jquery.ba-bbq/jquery.ba-bbq.js"></script>
<script type="text/javascript" src="modevlib/debug/aLog.js"></script>
<script type="text/javascript" src="lib/ccc/lib/jquery.tipsy.js"></script>
<script type="text/javascript" src="modevlib/threads/thread.js"></script>
<script type="text/javascript" src="modevlib/gui/ProgramFilter.js"></script>
<script type="text/javascript" src="modevlib/gui/RadioFilter.js"></script>
<script type="text/javascript" src="modevlib/util/aTimer.js"></script>
<link type="text/css" rel="stylesheet" href="lib/jquery-linedtextarea/jquery-linedtextarea.css"/>
<script type="text/javascript" src="lib/ccc/lib/tipsy.js"></script>
<script type="text/javascript" src="modevlib/rest/Rest.js"></script>
<script type="text/javascript" src="modevlib/aLibrary.js"></script>
<script type="text/javascript" src="lib/jquery-linedtextarea/jquery-linedtextarea.js"></script>
<link type="text/css" rel="stylesheet" href="lib/ccc/lib/tipsy.css"/>
<script type="text/javascript" src="modevlib/rest/ElasticSearch.js"></script>
<script type="text/javascript" src="modevlib/Bugzilla.js"></script>
<script type="text/javascript" src="modevlib/math/Stats.js"></script>
<script type="text/javascript" src="modevlib/ScrumBugs.js"></script>
<script type="text/javascript" src="modevlib/qb/MVEL.js"></script>
<script type="text/javascript" src="lib/ccc/def/def.js"></script>
<script type="text/javascript" src="modevlib/qb/Qb.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvc.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvc.text.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvc.color.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvc.trends.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvc.options.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/_data.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/meta/DimensionType.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/meta/ComplexType.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/meta/ComplexTypeProject.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/translation/TranslationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/translation/MatrixTranslationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/translation/CrosstabTranslationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/translation/RelationalTranslationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Atom.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Complex.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/ComplexView.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Datum.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Dimension.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Data.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Data.selected.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/GroupingSpec.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/DataOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/GroupingOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/LinearInterpolationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/LinearInterpolationOperSeriesState.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/ZeroInterpolationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/ZeroInterpolationOperSeriesState.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Data.operations.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/Data.compat.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/Role.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/Scene.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/Var.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/BasicSign.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Sign.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Panel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Label.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Dot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Line.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Area.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Bar.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/PieSlice.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Rule.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/Context.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/OptionsBase.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/Axis.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianAxis.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianAxisRootScene.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianAxisTickScene.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianFocusWindow.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/ColorAxis.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/SizeAxis.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/Legend.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletRootScene.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletGroupScene.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemScene.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemSceneSelection.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemSceneVisibility.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemRenderer.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemDefaultRenderer.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/Plot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/CartesianPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/CategoricalPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BarPlotAbstract.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BarPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/NormalizedBarPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/WaterfallPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/PointPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/MetricXYPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/MetricPointPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/PiePlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/HeatGridPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BoxPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BulletPlot.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcAbstract.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.visualRoles.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.data.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.plots.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.axes.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.panels.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.selection.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.extension.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBasePanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcPlotPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcMultiChartPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcTitlePanelAbstract.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcTitlePanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcLegendPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcCartesianAbstract.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcGridDockingPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcCartesianGridDockingPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcCartesianAbstractPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcPlotBgPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcCategoricalAbstract.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcCategoricalAbstractPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcAxisPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcAxisTitlePanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcPiePanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcPieChart.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBarAbstractPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBarAbstract.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBarPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBarChart.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcNormalizedBarPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcNormalizedBarChart.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/visual/legend/WaterfallBulletGroupScene.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcWaterfallPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcWaterfallChart.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcPointPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcPoint.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcHeatGridPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcHeatGridChart.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcMetricXYAbstract.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/translation/MetricPointChartTranslationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcMetricPointPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcMetricPoint.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBulletChart.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcParallelCoordinates.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcDataTree.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/data/translation/BoxplotChartTranslationOper.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBoxplotPanel.js"></script>
<script type="text/javascript" src="lib/ccc/pvc/pvcBoxplotChart.js"></script>
<script type="text/javascript" src="lib/ccc/data/q01-01.js"></script>
<script type="text/javascript" src="modevlib/main.js"></script>
<script type="text/javascript" src="modevlib/Dimension.js"></script>
<script type="text/javascript" src="modevlib/charts/aColor.js"></script>
<script type="text/javascript" src="modevlib/Settings.js"></script>
<script type="text/javascript" src="modevlib/qb/ESQuery.js"></script>
<script type="text/javascript" src="modevlib/gui/GUI.js"></script>
<script type="text/javascript" src="modevlib/charts/aChart.js"></script>
<script type="text/javascript" src="modevlib/Hierarchy.js"></script>
<script type="text/javascript" src="modevlib/Dimension-Bugzilla.js"></script>
<link type="text/css" rel="stylesheet" href="css/menu.css"/>
<script type="text/javascript" src="modevlib/Dimension-B2G.js"></script>
<script type="text/javascript" src="modevlib/gui/ProductFilter.js"></script>
<script type="text/javascript" src="modevlib/Dimension-Features.js"></script>
<script type="text/javascript" src="js/burndown.js"></script>
<script type="text/javascript" src="lib/sorttable/sorttable.js"></script>
<link rel="icon" href="images/fxos.ico" type="image/x-icon"/>


<script>
(function(i, s, o, g, r, a, m){
	i['GoogleAnalyticsObject'] = r;
	i[r] = i[r] || function(){
		(i[r].q = i[r].q || []).push(arguments)
	}, i[r].l = 1 * new Date();
	a = s.createElement(o),
		m = s.getElementsByTagName(o)[0];
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

ga('create', 'UA-49796218-5', 'mozilla.org');
ga('send', 'pageview');
</script>
</HEAD>
<BODY>
<table>
	<tr>
		<td style="vertical-align: top;">
			<div id="sidebar" style="width:300px;">
				<br><br>

				<div style="height: 30px; text-align: center;vertical-align:middle;">
					<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
				</div>

				<hr>
				<div id="description">
					Counting all dependent bugs over time<br>
					<ul>
						<li>The <b>Estimate</b> column is the p=?? value found in the status whiteboard. If there is no p value it shows "missing".</li>
						<li><b>Remaining Work</b> is the sum of the estimate, with missing values assumed to be 1.</li>
					</ul>
				</div>
				<hr>
				<div id="testMessage"></div>
				<hr>
				<div id="stats"></div>
				<hr>
				<div id="parameters" class="parameters">
				</div>
				<div id="filters" class="menu"></div>
			</div>
		</td>
		<td>
			<div style="width:807px;padding-left:7px">
				<h3 id="title"></h3>

				<div>
					<div id="feature-summary" style="position: relative;min-height:30px;"></div>
					<div id="chart" class="chart" style="position: relative;height:300px;"></div>
					<div id="chart_diff" class="chart" style="position: relative;height:300px;"></div>
					<div id="buglist" style="position: relative;width:800px"></div>
					<div id="info" style="position: relative;width:800px"></div>
				</div>
			</div>
		</td>
	</tr>
	<tr>
		<td colspan="2">
			<div class="footer">
				Source code at <a href="https://github.com/mozilla/charts/blob/master/fxos/burndown-feature.html">https://github.com/mozilla/charts/blob/master/fxos/burndown-feature.html</a>
			</div>
		</td>
	</tr>
</table>

<script type="application/javascript">

importScript([
	"modevlib/main.js",
	'modevlib/Dimension-Bugzilla.js',
	'modevlib/Dimension-B2G.js',
	'modevlib/Dimension-Features.js',
	"js/burndown.js",
	"lib/sorttable/sorttable.js"
], function(){

	NEEDED_FIELDS = ["status_whiteboard"];  //FOR GETTING THE SCRUMBUGZ p=N VALUES

	var raw_data = null;   //KEEP RAW DATA FOR RE-CHARTING
	var daily_data = null;
	var featureFilter = null;

	var thread;
	var createChart = function(){
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(function*(){
			try {
				yield (__createChart());
			} catch (e) {
				if (e.contains(Thread.Interrupted)) return;
				throw e;
			}//try
		});
	};

	var __createChart = function*(){
		$("#feature-summary").html("");
		$("#chart").html("");
		$("#chart_diff").html("");
		$("#buglist").html("");
		$("#info").html("");

		var TODAY = Date.today();

		var sampleMin = Date.newInstance(GUI.state.sampleMin);
		var sampleInterval = Duration.newInstance(GUI.state.sampleInterval);
		var sampleMax = Date.newInstance(GUI.state.sampleMax).addDay();
		var userFilter;
		try {
			userFilter = GUI.state.filter == "" ? {"match_all": {}} : CNV.JSON2Object(GUI.state.filter);
		}catch(e){
			userFilter =  {"match_all": {}};
		}//try
		var bug_ids = GUI.state.bugList.trim() == "" ? [] : GUI.state.bugList.split(",").map(function(v){
			return convert.String2Integer(v.trim());
		});

		var timeDomain = null;
		var needed_fields = null;
		var dateMarks = [];

		var milestones = GUI.state.epm.getSelectedParts();
		var milestoneFilter = null;
		if (milestones.length > 0) {
			//SHOW UI dates AS DISABLED
			$("#sampleMin").prop("disabled", true);
			$("#sampleMax").prop("disabled", true);

			//FIND REAL TIME RANGE
			sampleMin = aMath.min(TODAY.addDay(-14), aMath.MIN(milestones.select("start_date").map(Date.newInstance)));
			sampleMax = aMath.MAX(milestones.select("targetDate").map(Date.newInstance)).addDay(2);

			milestoneFilter = {"or" : milestones.select("esfilter")};

			milestones.select("dateMarks").forall(function(marks){
				dateMarks.appendArray(Array.newInstance(marks));
			});

		} else {
			//SHOW UI dates AS DISABLED
			$("#sampleMin").prop("disabled", false);
			$("#sampleMax").prop("disabled", false);
		}//endif


		var features = GUI.state.feature.getSelectedParts();
		if (features.length > 0) {
			var featureName = features.select("name").join(" and ");
			if (milestones.length > 0) {
				$("#title").text("Burndown for " + featureName + " (EPM " + milestones.select("name").join(" and ") + ")");
			} else {
				$("#title").text("Burndown for " + featureName);
			}//endif


			features.select("dateMarks").forall(function(marks){
				dateMarks.appendArray(Array.newInstance(marks));
			});

			featureFilter = {"or" : features.select("esfilter")};
			if (bug_ids.length > 0) featureFilter.or.append({"terms" : {"bug_id" : bug_ids}});
			needed_fields = Array.union(
				NEEDED_FIELDS,
				features.select("needed_fields"),
				milestones.select("needed_fields"),
				CNV.esFilter2properties(userFilter)
			);
			timeDomain = {"type" : "time", "min" : sampleMin, "max" : sampleMax, "interval" : sampleInterval, "dateMarks" : dateMarks};
			raw_data = yield(getRawDependencyData(featureFilter, timeDomain, needed_fields));
		} else {
			if (bug_ids.length == 0) {
				$("#title").text("Must select bug number, feature, or EPM");
				yield (null); //EXIT EARLY
			}//endif

			Thread.run(function*(){
				///////////////////////////////////////////////////////////////////////
				// SET TITLE TO THE TOP BUG DESCRIPTION
				///////////////////////////////////////////////////////////////////////
				var r = yield(ESQuery.run({
					"from" : "public_bugs",
					"select" : "short_desc",
					"esfilter" : {"and" : [
						{"terms" : {"bug_id" : bug_ids}},
						Mozilla.CurrentRecords.esfilter
					]}
				}));

				if (milestones.length > 0) {
<<<<<<< HEAD
					$("#title").html(r.list.map(convert.String2HTML).join("<br>") + "Milestone " + milestones.select("name").join(" and "));
=======
					$("#title").html(r.list.map(CNV.String2HTML).join("<br>") + "EPM " + milestones.select("name").join(" and "));
>>>>>>> master
				} else {
					$("#title").html(r.list.map(convert.String2HTML).join("<br>"));
				}//endif
			});

			featureFilter = {"terms" : {"bug_id" : bug_ids}};
			needed_fields = Array.union(
				NEEDED_FIELDS,
				features.select("needed_fields"),
				milestones.select("needed_fields"),
				CNV.esFilter2properties(userFilter)
			);
			timeDomain = {"type" : "time", "min" : sampleMin, "max" : sampleMax, "interval" : sampleInterval, "dateMarks" : dateMarks};
			raw_data = yield(getRawDependencyData(featureFilter, timeDomain, needed_fields));
		}//endif


		var currFeatureFilter = GUI.state.hierarchyMode.getSimpleState() != "All dependencies" ? coalesce(milestoneFilter, featureFilter) : {"match_all" : {}};
		daily_data = yield (getDailyDependencies(raw_data, {"and":[
<<<<<<< HEAD
			coalesce(milestoneFilter, {"match_all" : {}}),
			coalesce(featureFilter, {"match_all" : {}})
=======
			nvl(milestoneFilter, {"match_all" : {}}),
			nvl(featureFilter, {"match_all" : {}}),
			userFilter
>>>>>>> master
		]}));

		//LAST DAY WILL BE CONSIDERED CURRENT FEATURE LIST
		var currOpenBugs = daily_data.cube.last().filter({"and" : [
			{"term" : {"counted" : "Open"}},
			currFeatureFilter,
			userFilter
		]}).select("bug_id");

		var currTotalBugs = daily_data.cube.last().filter({"and" : [
			{"not" : {"term" : {"counted" : "none"}}},
			currFeatureFilter
		]}).select("bug_id");

		restOfCharting({
			"TODAY" : TODAY,
			"hierarchyMode" : GUI.state.hierarchyMode.getSimpleState(),
			"timeDomain" : timeDomain,
			"currOpenBugs" : currOpenBugs,
			"currTotalBugs" : currTotalBugs,
			"currFeatureFilter" : currFeatureFilter,
			"userFilter" : userFilter
		});
	};

	function __reChart(){
		Thread.run(function*(){
			$("#feature-summary").html("");
			$("#chart").html("");
			$("#chart_diff").html("");
			$("#buglist").html("");
			$("#info").html("");

			var sampleMin = Date.newInstance(GUI.state.sampleMin);
			var sampleInterval = Duration.newInstance(GUI.state.sampleInterval);
			var sampleMax = Date.newInstance(GUI.state.sampleMax).addDay();
			var userFilter;
			try {
				userFilter = GUI.state.filter == "" ? {"match_all": {}} : CNV.JSON2Object(GUI.state.filter);
			}catch(e){
				userFilter =  {"match_all": {}};
			}//try

			var milestones = GUI.state.epm.getSelectedParts();
			var milestoneFilter = null;
			if (milestones.length > 0) {
				$("#title").append(" (Milestone " + milestones.select("name").join(" and ") + ")");

				milestoneFilter = {"or" : milestones.select("esfilter")};
			}//endif

			var currFeatureFilter = GUI.state.hierarchyMode.getSimpleState() != "All dependencies" ? coalesce(milestoneFilter, featureFilter) : {"match_all" : {}};
			daily_data = yield (getDailyDependencies(raw_data, {"and":[
<<<<<<< HEAD
				coalesce(milestoneFilter, {"match_all" : {}}),
				coalesce(featureFilter, {"match_all" : {}})
=======
				nvl(milestoneFilter, {"match_all" : {}}),
				nvl(featureFilter, {"match_all" : {}}),
				userFilter
>>>>>>> master
			]}));

			//LAST DAY WILL BE CONSIDERED CURRENT FEATURE LIST
			var currOpenBugs = daily_data.cube.last().filter({"and" : [
				{"term" : {"counted" : "Open"}},
				currFeatureFilter,
				userFilter
			]}).select("bug_id");

			var currTotalBugs = daily_data.cube.last().filter({"and" : [
				{"not" : {"term" : {"counted" : "none"}}},
				currFeatureFilter,
				userFilter
			]}).select("bug_id");

			restOfCharting({
				"TODAY" : Date.today(),
				"hierarchyMode" : GUI.state.hierarchyMode.getSimpleState(),
				"timeDomain" : {"type" : "time", "min" : sampleMin, "max" : sampleMax, "interval" : sampleInterval},
				"currOpenBugs" : currOpenBugs,
				"currTotalBugs" : currTotalBugs,
				"currFeatureFilter" : currFeatureFilter,
				"userFilter" : userFilter
			})

		});
	}//function


	function restOfCharting(env){


		Thread.run(function*(){
			///////////////////////////////////////////////////////////////////////
			// SUMMARY OF FEATURE
			///////////////////////////////////////////////////////////////////////
			var total = env.currTotalBugs;
			var open = env.currOpenBugs;
			var closed = total.subtract(open);
			//FILL TEMPLATE
			var summary = $("#feature-summary");
			var TEMPLATE = new Template("<div>" +
				"<div id='featureTotal' class='hoverable' style='display:inline-block;margin:5px 10px 5px 10px;'>Total Bugs: {{total}}</div>" +
				"<div id='featureClosed' class='hoverable' style='display:inline-block;margin:5px 10px 5px 10px;'>Closed: {{closed}} ({{closed_percent}}%)</div>" +
				"<div id='featureOpen' class='hoverable' style='display:inline-block;margin:5px 10px 5px 10px;'>Open Bugs: {{open}}</div>" +
				"</div");
			summary.html(TEMPLATE.replace({
				"total" : total.length,
				"open" : open.length,
				"closed" : closed.length,
				"closed_percent" : aMath.round((closed.length) / total.length * 100)
			}));

			//ADD BUG CLICKERS
			$("#featureTotal").click(function(){
				Bugzilla.showBugs(total);
			});
			$("#featureClosed").click(function(){
				Bugzilla.showBugs(closed);
			});
			$("#featureOpen").click(function(){
				Bugzilla.showBugs(open);
			});

		});

		Thread.run(function*(){
			////////////////////////////////////////////////////////////////////////////
			// CURRENT BUGS LIST
			////////////////////////////////////////////////////////////////////////////
			var a = Log.action("Get buglist", true);
			var bugs = yield (ESQuery.run({
				"from" : "public_bugs",
				"select" : [
					"bug_id",
					"short_desc",
					"assigned_to",
					"bug_status",
					"resolution",
					"status_whiteboard",
					"priority"
				],
				"esfilter" : {"and" : [
					Mozilla.BugStatus.Open.esfilter,
					Mozilla.CurrentRecords.esfilter,
					{"terms" : {"bug_id" : env.currOpenBugs}},
					env.userFilter
				]}
			}));
			Log.actionDone(a);

			var details = yield (Qb.calc2List({
				"from" : bugs,
				"select" : [
					{"name" : "bug_id", "value" : "bug_id"},
					{"name" : "Summary", "value" : "short_desc"},
					{"name" : "Owner", "value" : "assigned_to"},
					{"name" : "Status", "value" : "bug_status + (resolution ? ' - '+resolution : '')"},
					{"name" : "Estimate", "value" : "coalesce(ScrumBugs.parse(status_whiteboard).points, 'missing')"},
					{"name" : "Priority", "value" : "priority"}
				],
				"sort" : ["Status", "bug_id"]
			}));

			var table = $("#buglist").html(bugDetails(details.list)).find("table")[0];
			sorttable.makeSortable(table)
		});

		var simpleCount = null;
		var countThread = Thread.run(function*(){
			///////////////////////////////////////////////////////////////////////
			// HISTORICAL COUNT
			///////////////////////////////////////////////////////////////////////
			var a = Log.action("Adding", true);
			var chart = yield(Q({
				"from" : raw_data,
				"select" : [
					{"name" : "count", "value" : "1", "aggregate" : "sum", "default" : 0},
					{"name" : "work", "value" : "coalesce(ScrumBugs.parse(status_whiteboard).points, 1)-0", "aggregate" : "sum", "default" : 0}
				],
				"edges" : [
					{"name" : "status", "value" : "counted", "domain" : {"type" : "set", "key" : "value", "partitions" : [
						{"name" : "Open", "value" : "Open"},
						{"name" : "Closed", "value" : "Closed"},
						{"name" : "none", "value" : "none"}
					]}},
					{"name" : "date",
						"value" : "date",
						"allowNulls" : false,
						"domain" : env.timeDomain
					}
				],
				"where" : {"and":[
					env.currFeatureFilter,
					env.userFilter
				]}
			}));

			//CONVERT EDGE TO ATTRIBUTES
			simpleCount = yield(Q({
				"from" : chart,
				"select" : [
//				{"name":"Total_Bugs", "value":"status.name!='none' ? count : null", "aggregate":"sum", "default":0},
					{"name" : "Open Bugs", "value" : "status.name=='Open' ? count : null", "aggregate" : "sum", "default" : 0},
					{"name" : "Remaining Work", "value" : "status.name=='Open' ? work : null", "aggregate" : "sum", "default" : 0},
					{"name" : ".", "value" : "0", "aggregate" : "one", "style" : {"color" : "#00000000"}}
				],
				"edges" : [
					{"name" : "date",
						"value" : "date",
						"allowNulls" : false,
						"domain" : env.timeDomain
					}
				]
			}));

			var tempTimeDomain = simpleCount.edges[0].domain;

			//SHOW FUTURE VALUES AS NULLS
			simpleCount.cube.forall(function(v, i){
				if (tempTimeDomain.partitions[i].min > env.TODAY.addDay()) {
					simpleCount.cube[i] = Map.zip(mapAllKey(v, function(k, v){
						if (k == ".") {
							return [k, 0];
						} else {
							return [k, null];
						}
					}));
				}//endif
			});

			Log.actionDone(a);

		});


		var churnTimeDomain = Map.setDefault({"max" : env.timeDomain.max.addDay(-1)}, env.timeDomain);  //ONE LESS DAY FOR CHURN

		var ideal = null;

		var churnThread = Thread.run(function*(){
			////////////////////////////////////////////////////////////////////////////
			// CHURN
			////////////////////////////////////////////////////////////////////////////
			var chart = yield(Q({
				"from" : daily_data,
				"select" : [
					{"name" : "Opened", "value" : "churn > 0 ? 1 : 0", "aggregate" : "sum", "default" : 0, "style" : {"color" : Color.GREEN.multiply(0.5).hue(20)}},
					{"name" : "Closed", "value" : "churn < 0 ? -1 : 0", "aggregate" : "sum", "default" : 0, "style" : {"color" : Color.RED.multiply(0.7).hue(10)}}
				],
				"edges" : [
					{"name" : "date", "value" : "date",
						"allowNulls" : false,
						"domain" : churnTimeDomain
					}
				],
				"where" : {"and":[
					env.currFeatureFilter,
					env.userFilter
				]}
			}));

			a = Log.action("Make chart", true);
			aChart.show({
				"name" : "Open and Close Rates",
				"id" : "chart_diff",
				"sheetDiv" : "info",
				"type" : "bar",
				"stacked" : true,
				"cube" : chart,
				"xAxisSize" : 50,
				"clickAction" : function(series, x, d){
					Thread.run(function*(){
						var where = {"and" : [
							{"term" : {"date" : x}},
							{"term" : {"churn" : series == "Opened" ? 1 : -1}}
						]};

						var buglist = daily_data.list.filter(where);
						Bugzilla.showBugs(buglist.select("bug_id"));
					});
				}//click
			});
			Log.actionDone(a);

			var DUE_DATE = Date.newInstance(GUI.state.sampleMax).addDay();
			var START_DATE = env.timeDomain.min;
			var SAMPLE_DURATION = Duration.newInstance("2week");

			perDay = (yield(Qb.calc2List({
				"from" : chart,
				"select" : [
					{"name" : "opened", "value" : "Opened", "aggregate" : "sum"},
					{"name" : "closed", "value" : "Closed", "aggregate" : "sum"}
				],
				"where" : START_DATE.getMilli() + "<=date.getMilli() && date.getMilli()<" + Date.min(DUE_DATE, env.TODAY).getMilli()
			}))).list[0];
			daysInSprint = Date.diffWeekday(Date.min(DUE_DATE, env.TODAY), START_DATE);

			var sampleEnd = Date.min(DUE_DATE, env.TODAY);
			var sampleStart = Date.max(START_DATE, sampleEnd.subtract(SAMPLE_DURATION));
			daysInSample = Date.diffWeekday(sampleEnd, sampleStart);
			perDayInSample = (yield(Qb.calc2List({
				"from" : chart,
				"select" : [
					{"name" : "opened", "value" : "Opened", "aggregate" : "sum"},
					{"name" : "closed", "value" : "Closed", "aggregate" : "sum"}
				],
				"where" : sampleStart.getMilli() + "<=date.getMilli() && date.getMilli()<" + sampleEnd.getMilli()
			}))).list[0];

			//CURRENT OPEN BUG COUNT
			var todayOpenBugs = daily_data.cube[env.TODAY.subtract(START_DATE).divideBy(Duration.DAY)]
				.filter({"and":[
					env.currFeatureFilter,
					env.userFilter,
					{"term" : {"counted" : "Open"}}
				]})
				.length;
			var daysRemaining = Date.diffWeekday(DUE_DATE, env.TODAY);
			var moreBugsExpected = perDayInSample.opened / daysInSample * daysRemaining;
			var requiredRate = (todayOpenBugs + moreBugsExpected) / daysRemaining;

			$("#stats").html("");

			if (daysInSample >= 1) {
				$("#stats").append(
					'<span class="parameter_name">Workdays in release:</span>' + daysInSprint + '<br>' +
						'<span class="parameter_name">New bugs per day:</span>' + aMath.round(perDayInSample.opened / daysInSample, 1) + '<br>' +
						'<span class="parameter_name">Closed per day:</span>' + aMath.round(Math.abs(perDayInSample.closed) / daysInSample, 1) + '<br>' +
						''
				);
			}//endif

			if (daysRemaining > 1) {
				$("#stats").append(
					'<span class="parameter_name">Days remaining:</span>' + aMath.round(daysRemaining, 0) + '<br>' +
					'<span class="parameter_name">Req\'d Closed / Day:</span>' + aMath.round(requiredRate, 1) + '<br>'
				);
			}//endif

			ideal = function(date){
				if (date > DUE_DATE) {
					return 0;
				} else {
					return aMath.round(todayOpenBugs - (todayOpenBugs * Date.diffWeekday(date, env.TODAY) / daysRemaining));
				}//endif
			};


		});


		Thread.run(function*(){
			////////////////////////////////////////////////////////////////////////////
			// RENDER BURNDOWN
			////////////////////////////////////////////////////////////////////////////

			yield (churnThread.join());
			yield (countThread.join());


//		//IDEAL BURNDOWN
			aChart.addPredictionLine({
				"source" : {
					"name" : "Open Bugs",
					"domain" : env.timeDomain,
					"data" : simpleCount.cube
				},
				"predict" : {
					"name" : "ideal",
					"domain" : {"min" : env.TODAY, "max" : env.timeDomain.max},
					"line" : ideal
				}
			});

			simpleCount.columns.insert(0, {"name" : "Required Burndown", "value" : "ideal", "style" : {"color" : "lightgray"}});
			simpleCount.select.insert(0, {"name" : "ideal", "style" : {"color" : "lightgray"}});
			simpleCount.columns.push({"name" : "ideal"});

			aChart.show({
				"id" : "chart",
				"sheetDiv" : "info",
				"type" : "line",
				"stacked" : false,
				"cube" : simpleCount,
				"xAxisSize" : 50,
				extensionPoints : {
					dot_shapeRadius : 3,
					dot_shape : "circle",
					line_lineWidth : 3
				},
				"clickAction" : function(series, x, d){
					var series2filter = {
						"Open Bugs" : {"term" : {"counted" : "Open"}},
						"Remaining Work" : {"term" : {"counted" : "Open"}},
						"Total" : {"not" : {"term" : {"counted" : "none"}}}
					};

					Thread.run(function*(){
						var buglist = (yield (Q({
							"from" : daily_data,
							"select" : {"value" : "bug_id", "aggregate" : "minimum"},
							"edges" : [
								{"name" : "unique", "value" : "bug_id"}
							],
							"esfilter" : {"and" : [
								series2filter[series],
								env.userFilter,
								{"term" : {"date" : x}}
							]}
						})));

						Bugzilla.showBugs([].union(buglist.cube));
					});
				}//click
			});
		});
	}


	$(document).ready(function(){
		GUI.setup(createChart, [
			{"id" : "bugList", "name" : "Tracking Bug(s)", "type" : "text", "default" : null},
			{"id" : "sampleMin", "name" : "Start Date", "type" : "time", "default" : Date.eod().add("-6week")},
			{"id" : "sampleMax", "name" : "End Date", "type" : "time", "default" : Date.today().ceilingWeek()},
			{"id" : "sampleInterval", "name" : "Interval", "type" : "duration", "default" : "day"},
			{"id" : "filter", "name" : "Filter", "type" : "string", "default" : ""},
			{"id" : "hierarchyMode", "name" : "Dependencies", "type" : RadioFilter.newInstance({
				"id" : "hierarchyMode",
				"name" : "Dependencies",
				"message" : "Chart all bug dependencies (default), or chart only the bugs matching criterion<br><br>",
				"options" : ["All dependencies", "Matching criterion"],
				"default" : "All dependencies",
				"refreshCallback" : __reChart
			})},
			{"id" : "feature", "name" : "Feature", "type" : PartitionFilter.newInstance({
				"id" : "features",
				"name" : "All Features",
				"dimension" : Mozilla.Feature,
				"onlyOne" : false,
				"expandAll" : true,
				"treeDepth" : 0
			})},
			{"id" : "epm", "name" : "EPM", "type" : PartitionFilter.newInstance({
				"id" : "epms",
				"name" : "All EPMs",
				"description" : "You may restrict the feature to an EPM",
				"dimension" : Mozilla.EPM,
				"onlyOne" : false,
				"expandAll" : true,
				"treeDepth" : 0,
				"refreshCallback" : __reChart
			})}
		],
			[
				"sampleMin=Date.newInstance(sampleMin).floor(Duration.newInstance(sampleInterval)).format('yyyy-MM-dd')",
				"sampleMax=Date.newInstance(sampleMax).addDay(1).floor(Duration.newInstance(sampleInterval)).addDay(-1).format('yyyy-MM-dd')"
			],
			"bugs",
			false
		);

//	GUI.productFilter = ["B2G 1.0.0 (TEF)"];

	});

});
</script>


</BODY>
</HTML>

